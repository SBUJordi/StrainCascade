#!/bin/bash

# Copyright (c) 2024-2025, University of Bern, Department for BioMedical Research, Sebastian Bruno Ulrich JORDI
# This source code is licensed under the MIT No Attribution License (MIT-0)
# found in the LICENSE file in the root directory of this source tree.

# StrainCascade_Flye_assembly.sh
# Description: Performs Flye genome assembly as part of StrainCascade

set -euo pipefail

# Function to display usage information
show_usage() {
    cat << EOF
Usage: $0 <script_dir> <logs_dir> <log_name> <utils_file> <apptainer_images_dir> <input_file> 
          <output_dir> <sample_name> <sequencing_type> <threads> <genome_assembly_main_abs> <reproducibility_mode>
EOF
    exit 1
}

# Validate input parameters
[[ $# -eq 12 ]] || show_usage

# Constants from command line arguments
readonly SCRIPT_DIR="$1"
readonly LOGS_DIR="$2"
readonly LOG_NAME="$3"
readonly UTILS_FILE="$4"
readonly APPTAINER_DIR="$5"
readonly INPUT_FILE="$6"
readonly OUTPUT_DIR="$7"
readonly SAMPLE_NAME="$8"
readonly SEQUENCING_TYPE="$9"
readonly INITIAL_THREADS="${10}"
readonly GENOME_ASSEMBLY_DIR="${11}"
readonly REPRODUCIBILITY_MODE="${12}"

# Set threads based on algorithm type
if [[ "${REPRODUCIBILITY_MODE}" == "deterministic" ]]; then
    readonly THREADS=1
else
    readonly THREADS="${INITIAL_THREADS}"
fi

# Derived constants
readonly FLYE_OUTPUT_DIR="$OUTPUT_DIR/Flye_assembly_results"
readonly GENOME_SIZE_FILE="$GENOME_ASSEMBLY_DIR/informed_genome_size_estimation.txt"
readonly DEFAULT_GENOME_SIZE="4.5m"
readonly ASSEMBLY_PREFIX="${SAMPLE_NAME}_assembly_flye"
readonly FINAL_ASSEMBLY_NAME="${ASSEMBLY_PREFIX}.fasta"
readonly MIN_VALID_GENOME_SIZE=1300000
readonly MAX_PLAUSIBLE_GENOME_SIZE=10000000

# Source utility functions
source "$UTILS_FILE"

log "$LOGS_DIR" "$LOG_NAME" "Threads set to ${THREADS} based on algorithm type ${REPRODUCIBILITY_MODE}."

# Create required output directory
create_directory "$FLYE_OUTPUT_DIR"

# Clean up empty FASTA files
log "$LOGS_DIR" "$LOG_NAME" "Checking for empty FASTA files in $GENOME_ASSEMBLY_DIR"
while IFS= read -r -d '' file; do
    if [[ -f "$file" && ! -s "$file" ]]; then
        log "$LOGS_DIR" "$LOG_NAME" "Removing empty file: $(basename "$file")"
        rm "$file"
    fi
done < <(find "$GENOME_ASSEMBLY_DIR" -type f -name "*.fasta" -print0)

# Find required Apptainer image
readonly straincascade_genome_assembly_sif=$(find_apptainer_sif_file "$APPTAINER_DIR" 'straincascade_genome_assembly*.sif')

# Initialize assembly parameters
genome_size="$DEFAULT_GENOME_SIZE"
readonly ESTIMATE_GENOME_SIZE=$([[ -f "$GENOME_SIZE_FILE" ]] && echo "no" || echo "yes")

# Use existing genome size if available
if [[ -f "$GENOME_SIZE_FILE" ]]; then
    genome_size=$(awk '{printf "%.1fm\n", $1/1000000}' "$GENOME_SIZE_FILE")
    log "$LOGS_DIR" "$LOG_NAME" "Using pre-existing genome size estimation: $genome_size"
fi

# Create deterministic entropy source
readonly ENTROPY_FILE="$FLYE_OUTPUT_DIR/deterministic_entropy_file"
if [[ ! -f "$ENTROPY_FILE" ]]; then
    dd if=/dev/zero bs=1024 count=100 > "$ENTROPY_FILE"
    log "$LOGS_DIR" "$LOG_NAME" "Deterministic entropy file created at $ENTROPY_FILE"
fi

# Main assembly execution
log "$LOGS_DIR" "$LOG_NAME" "Running Flye Assembler for $INPUT_FILE"
log "$LOGS_DIR" "$LOG_NAME" "Output directory: $FLYE_OUTPUT_DIR"
log "$LOGS_DIR" "$LOG_NAME" "Using $THREADS threads"

# First assembly run
apptainer exec \
    --bind "$(dirname "$INPUT_FILE")":/mnt/input \
    --bind "$FLYE_OUTPUT_DIR":/mnt/output \
    --bind "$ENTROPY_FILE":/dev/random \
    --bind "$ENTROPY_FILE":/dev/urandom \
    "$straincascade_genome_assembly_sif" flye \
    --"$SEQUENCING_TYPE" "/mnt/input/$(basename "$INPUT_FILE")" \
    --out-dir /mnt/output \
    --genome-size "$genome_size" \
    --threads "$THREADS" \
    --iterations 2 || {
        log "$LOGS_DIR" "$LOG_NAME" "Error: Flye assembly failed. Skipping Flye assembly."
        exit 0
    }

# Process assembly output
if [[ -f "$FLYE_OUTPUT_DIR/assembly.fasta" ]]; then
    # Check if file is empty
    if [[ ! -s "$FLYE_OUTPUT_DIR/assembly.fasta" ]]; then
        log "$LOGS_DIR" "$LOG_NAME" "Warning: Empty assembly file was generated by Flye. This is indicative of assembly failure and the assembly file will not be used downstream."
        exit 0
    fi
    mv "$FLYE_OUTPUT_DIR/assembly.fasta" "$FLYE_OUTPUT_DIR/$FINAL_ASSEMBLY_NAME"
    log "$LOGS_DIR" "$LOG_NAME" "Renamed assembly.fasta to $FINAL_ASSEMBLY_NAME"
    
    cp "$FLYE_OUTPUT_DIR/$FINAL_ASSEMBLY_NAME" "$GENOME_ASSEMBLY_DIR/"
    log "$LOGS_DIR" "$LOG_NAME" "Copied assembly to $GENOME_ASSEMBLY_DIR"
else
    log "$LOGS_DIR" "$LOG_NAME" "Error: Assembly file not found in $FLYE_OUTPUT_DIR. Skipping Flye assembly."
    exit 0
fi

# Perform genome size estimation if needed
if [[ "$ESTIMATE_GENOME_SIZE" == "yes" ]]; then
    log "$LOGS_DIR" "$LOG_NAME" "Performing genome size estimation"
    
    # Calculate genome size with error handling
    if ! genome_size=$(grep -v ">" "$FLYE_OUTPUT_DIR/$FINAL_ASSEMBLY_NAME" | tr -d '\n' | tr -cd 'ACGTNacgtn' | wc -c); then
        log "$LOGS_DIR" "$LOG_NAME" "Error: Failed to calculate genome size from assembly. Skipping Flye assembly."
        exit 0
    fi
    log "$LOGS_DIR" "$LOG_NAME" "Estimated genome size: $genome_size bp"
    
    # Validate genome size
    if (( genome_size > MAX_PLAUSIBLE_GENOME_SIZE )); then
    log "$LOGS_DIR" "$LOG_NAME" "Warning: Estimated genome size $genome_size bps is implausibly large for gut bacteria \
(https://doi.org/10.1038/s41467-023-37396-x, Fig. 1a). Continuing with assembly."
    elif (( genome_size <= MIN_VALID_GENOME_SIZE )); then
        log "$LOGS_DIR" "$LOG_NAME" "Warning: Estimated genome size $genome_size bps may be too small for independent cell replication \
(https://www.science.org/doi/10.1126/science.1114057, Fig. 1). Continuing with assembly."
    else
        log "$LOGS_DIR" "$LOG_NAME" "Genome size $genome_size bp is within expected range"
        echo "$genome_size" > "$GENOME_SIZE_FILE"
        
        # Run second assembly with estimated genome size
        genome_size="$(awk '{printf "%.1fm\n", $1/1000000}' <<< "$genome_size")"
        log "$LOGS_DIR" "$LOG_NAME" "Running second assembly with estimated genome size: $genome_size"
        
        apptainer exec \
            --bind "$(dirname "$INPUT_FILE")":/mnt/input \
            --bind "$FLYE_OUTPUT_DIR":/mnt/output \
            --bind "$ENTROPY_FILE":/dev/random \
            --bind "$ENTROPY_FILE":/dev/urandom \
            "$straincascade_genome_assembly_sif" flye \
            --"$SEQUENCING_TYPE" "/mnt/input/$(basename "$INPUT_FILE")" \
            --out-dir /mnt/output \
            --genome-size "$genome_size" \
            --threads "$THREADS" \
            --iterations 2 || {
                log "$LOGS_DIR" "$LOG_NAME" "Error: Second Flye assembly failed. Skipping Flye assembly."
                exit 0
            }
        
        # Process second assembly output
        if [[ -f "$FLYE_OUTPUT_DIR/assembly.fasta" ]]; then
            # Check if file is empty
            if [[ ! -s "$FLYE_OUTPUT_DIR/assembly.fasta" ]]; then
                log "$LOGS_DIR" "$LOG_NAME" "Warning: Empty assembly file was generated by second Flye run. This is indicative of assembly failure and the assembly file will not be used downstream."
                exit 0
            fi
            mv "$FLYE_OUTPUT_DIR/assembly.fasta" "$FLYE_OUTPUT_DIR/$FINAL_ASSEMBLY_NAME"
            cp "$FLYE_OUTPUT_DIR/$FINAL_ASSEMBLY_NAME" "$GENOME_ASSEMBLY_DIR/"
            log "$LOGS_DIR" "$LOG_NAME" "Second assembly completed and saved"
        else
            log "$LOGS_DIR" "$LOG_NAME" "Error: Second assembly file not found. Skipping Flye assembly."
            exit 0
        fi
    fi
fi

# Clean up empty FASTA files
log "$LOGS_DIR" "$LOG_NAME" "Checking for empty FASTA files in $GENOME_ASSEMBLY_DIR"
while IFS= read -r -d '' file; do
    if [[ -f "$file" && ! -s "$file" ]]; then
        log "$LOGS_DIR" "$LOG_NAME" "Removing empty file: $(basename "$file")"
        rm "$file"
    fi
done < <(find "$GENOME_ASSEMBLY_DIR" -type f -name "*.fasta" -print0)

log "$LOGS_DIR" "$LOG_NAME" "Flye assembly completed successfully for $SAMPLE_NAME"