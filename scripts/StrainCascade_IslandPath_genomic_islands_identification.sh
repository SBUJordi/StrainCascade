#!/bin/bash

# Copyright (c) 2024-2025, University of Bern, Department for BioMedical Research, Sebastian Bruno Ulrich JORDI
# This source code is licensed under the MIT No Attribution License (MIT-0)
# found in the LICENSE file in the root directory of this source tree.

# StrainCascade_IslandPath_genomic_islands_identification.sh
# Description: Identifies genomic islands using IslandPath-DIMOB as part of StrainCascade

set -euo pipefail

# Function to display usage information
show_usage() {
    echo "Usage: $0 <script_dir> <logs_dir> <log_name> <utils_file> <apptainer_images_dir> <output_dir> <sample_name> <genome_assembly_main_abs> <genome_annotation_main_abs> <functional_analysis_main_abs> <results_integration_abs> <version>"
    exit 1
}

# Validate input parameters
[[ $# -eq 12 ]] || show_usage

# Constants from command line arguments
readonly SCRIPT_DIR="$1"
readonly LOGS_DIR="$2"
readonly LOG_NAME="$3"
readonly UTILS_FILE="$4"
readonly APPTAINER_DIR="$5"
readonly OUTPUT_DIR="$6"
readonly SAMPLE_NAME="$7"
readonly GENOME_ASSEMBLY_DIR="$8"
readonly GENOME_ANNOTATION_DIR="$9"
readonly FUNCTIONAL_ANALYSIS_DIR="${10}"
readonly RESULTS_INTEGRATION_DIR="${11}"
readonly VERSION="${12}"

# Derived constants
readonly ISLANDPATH_OUTPUT_DIR="$OUTPUT_DIR/IslandPath_genomic_island_identification_results"
readonly QS_FILES_DIR="$RESULTS_INTEGRATION_DIR/qs_files"
readonly TEMP_INPUT_DIR="$ISLANDPATH_OUTPUT_DIR/temp_input"

# Source utility functions
source "$UTILS_FILE"

# Create required directories
create_directory "$ISLANDPATH_OUTPUT_DIR"
create_directory "$QS_FILES_DIR"
create_directory "$TEMP_INPUT_DIR"

# Find required Apptainer images
straincascade_taxonomic_functional_analysis_sif=$(find "$APPTAINER_DIR" -name 'straincascade_taxonomic_functional_analysis*.sif' -print -quit)
r_sif=$(find "$APPTAINER_DIR" -name 'r_4.4.1*.sif' -print -quit)

# Find appropriate GenBank input file
bakta_file=$(find "$GENOME_ANNOTATION_DIR" -type f -name "*annotation_bakta.gbff" -print -quit)
prokka_file=$(find "$GENOME_ANNOTATION_DIR" -type f -name "*annotation_prokka.gbk" -print -quit)
generic_file=$(find "$GENOME_ANNOTATION_DIR" -type f \( -name "*.gbk" -o -name "*.gbff" -o -name "*.embl" \) -print -quit)

genbank_file_to_use=""
file_origin=""

if [[ -n "$bakta_file" ]]; then
    log "$LOGS_DIR" "$LOG_NAME" "Using Bakta-generated GBFF file: $bakta_file"
    genbank_file_to_use="$bakta_file"
    file_origin="bakta"
elif [[ -n "$prokka_file" ]]; then
    log "$LOGS_DIR" "$LOG_NAME" "Using Prokka-generated GBK file: $prokka_file"
    genbank_file_to_use="$prokka_file"
    file_origin="prokka"
elif [[ -n "$generic_file" ]]; then
    log "$LOGS_DIR" "$LOG_NAME" "Using alternative annotation file: $generic_file"
    genbank_file_to_use="$generic_file"
    file_origin="non_StrainCascade_tool"
else
    log "$LOGS_DIR" "$LOG_NAME" "Error: No suitable annotation file found. Please run Bakta or Prokka annotation first."
    exit 0
fi

# Log analysis start
log "$LOGS_DIR" "$LOG_NAME" "Starting IslandPath analysis for $genbank_file_to_use (source: $file_origin)"

# Prepare input file
readonly input_file="${SAMPLE_NAME}_${file_origin}_annotation_islandpath.gbk"
cp "$genbank_file_to_use" "$TEMP_INPUT_DIR/$input_file"

# Prepare output filename
readonly output_file="${SAMPLE_NAME}_results_genomic_island_identification_islandpath.gff3"

# Build IslandPath command
islandpath_cmd="/opt/conda/envs/islandpath_env/opt/islandpath/Dimob.pl \
    /mnt/input/$input_file \
    /mnt/output/$output_file"

# Run IslandPath analysis
apptainer exec \
    --bind "$TEMP_INPUT_DIR":/mnt/input \
    --bind "$ISLANDPATH_OUTPUT_DIR":/mnt/output \
    "$straincascade_taxonomic_functional_analysis_sif" \
    bash -c "source /opt/conda/etc/profile.d/conda.sh && \
             conda activate islandpath_env && \
             $islandpath_cmd" || {
    log "$LOGS_DIR" "$LOG_NAME" "Error: IslandPath analysis failed"
    rm -rf "$TEMP_INPUT_DIR"
    exit 1
}

# Copy output files to functional analysis directory
if output_files=$(find "$ISLANDPATH_OUTPUT_DIR" -name "*.gff3" -type f); then
    for file in $output_files; do
        cp "$file" "$FUNCTIONAL_ANALYSIS_DIR/"
    done
else
    echo "Error: No GFF3 files generated by IslandPath"
    rm -rf "$TEMP_INPUT_DIR"
    exit 1
fi

# Cleanup
rm -rf "$TEMP_INPUT_DIR"
find "$GENOME_ANNOTATION_DIR" -name "dimob_*" -exec rm -rf {} +
[[ -f "$(dirname "$OUTPUT_DIR")/Dimob.log" ]] && rm "$(dirname "$OUTPUT_DIR")/Dimob.log"

# Process results with R
readonly R_SCRIPT_DIR="$SCRIPT_DIR/R_scripts"

# Find required files
gff_file=$(find "$FUNCTIONAL_ANALYSIS_DIR" -name '*islandpath.gff3' -print -quit)
[[ -z "$gff_file" ]] && {
    echo "Error: Required GFF3 file not found"
    exit 1
}

# Find analysis assembly file
analysis_assembly_file=$(find "$GENOME_ASSEMBLY_DIR" -type f \( -name "*.fasta" -o -name "*.fa" -o -name "*.fna" \) -print -quit)

# Log R processing configuration
cat << EOF
Processing IslandPath results with R using the following configuration:
GFF3 file: $gff_file
$([ -n "$analysis_assembly_file" ] && echo "FASTA file: $analysis_assembly_file" || echo "No FASTA file found")
StrainCascade version v$VERSION
EOF

# Prepare R script arguments
[[ -n "$analysis_assembly_file" ]] && {
    fasta_bind="--bind $(dirname "$analysis_assembly_file"):/mnt/input_fasta"
    fasta_arg="--fasta /mnt/input_fasta/$(basename "$analysis_assembly_file")"
} || {
    fasta_bind=""
    fasta_arg=""
}

# Run R script for processing
apptainer exec \
    --bind "$R_SCRIPT_DIR":/mnt/r_script_dir \
    --bind "$FUNCTIONAL_ANALYSIS_DIR":/mnt/input \
    $fasta_bind \
    --bind "$QS_FILES_DIR":/mnt/output \
    "$r_sif" \
    Rscript "/mnt/r_script_dir/R_process_islandpath.R" \
    --output_dir "/mnt/output" \
    --gff_file "/mnt/input/$(basename "$gff_file")" \
    $fasta_arg \
    --version "$VERSION" || {
    echo "Error: R processing failed"
    exit 1
}

echo "IslandPath analysis completed successfully"