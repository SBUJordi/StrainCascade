#!/bin/bash

# Copyright (c) 2024-2025, University of Bern, Department for BioMedical Research, Sebastian Bruno Ulrich JORDI
# This source code is licensed under the MIT No Attribution License (MIT-0)
# found in the LICENSE file in the root directory of this source tree.

# StrainCascade_SPAdes_assembly.sh
# Description: Performs SPAdes genome assembly as part of StrainCascade pipeline

set -euo pipefail

# Function to display usage information
show_usage() {
    cat << EOF
Usage: $0 <script_dir> <logs_dir> <log_name> <utils_file> <apptainer_images_dir> 
          <input_file> <output_dir> <sample_name> <sequencing_type> 
          <threads> <genome_assembly_main_abs> <reproducibility_mode>
EOF
    exit 1
}

# Validate input parameters
[[ $# -eq 12 ]] || show_usage

# Constants from command line arguments
readonly SCRIPT_DIR="$1"
readonly LOGS_DIR="$2"
readonly LOG_NAME="$3"
readonly UTILS_FILE="$4"
readonly APPTAINER_DIR="$5"
readonly INPUT_FILE="$6"
readonly OUTPUT_DIR="$7"
readonly SAMPLE_NAME="$8"
readonly SEQUENCING_TYPE="$9"
readonly INITIAL_THREADS="${10}"
readonly GENOME_ASSEMBLY_DIR="${11}"
readonly REPRODUCIBILITY_MODE="${12}"

# Set threads based on algorithm type
if [[ "${REPRODUCIBILITY_MODE}" == "deterministic" ]]; then
    readonly THREADS=1
else
    readonly THREADS="${INITIAL_THREADS}"
fi

# Derived constants
readonly SPADES_OUTPUT_DIR="$OUTPUT_DIR/SPAdes_assembly_results"
readonly MIN_VALID_GENOME_SIZE=1300000
readonly MAX_PLAUSIBLE_GENOME_SIZE=10000000
readonly ASSEMBLY_PREFIX="${SAMPLE_NAME}_assembly_spades"
readonly FINAL_ASSEMBLY_NAME="${ASSEMBLY_PREFIX}.fasta"
readonly GENOME_SIZE_FILE="$GENOME_ASSEMBLY_DIR/informed_genome_size_estimation.txt"

# Source utility functions
source "$UTILS_FILE"

log "$LOGS_DIR" "$LOG_NAME" "Threads set to ${THREADS} based on algorithm type ${REPRODUCIBILITY_MODE}."

# Create required output directory
create_directory "$SPADES_OUTPUT_DIR"

# Clean up empty FASTA files
log "$LOGS_DIR" "$LOG_NAME" "Checking for empty FASTA files in $GENOME_ASSEMBLY_DIR"
while IFS= read -r -d '' file; do
    if [[ -f "$file" && ! -s "$file" ]]; then
        log "$LOGS_DIR" "$LOG_NAME" "Removing empty file: $(basename "$file")"
        rm "$file"
    fi
done < <(find "$GENOME_ASSEMBLY_DIR" -type f -name "*.fasta" -print0)

# Find required Apptainer image
readonly straincascade_genome_assembly_sif=$(find_apptainer_sif_file "$APPTAINER_DIR" 'straincascade_genome_assembly*.sif')

# Determine sequencing flag based on input type
readonly SPADES_FLAG=$(case "$SEQUENCING_TYPE" in
    "pacbio-hifi"|"pacbio-corr"|"nano-corr"|"nano-hq") echo "-s" ;;
    *) echo "-s" ;;
esac)

# Create deterministic entropy source
readonly ENTROPY_FILE="$SPADES_OUTPUT_DIR/deterministic_entropy_file"
if [[ ! -f "$ENTROPY_FILE" ]]; then
    dd if=/dev/zero bs=1024 count=100 > "$ENTROPY_FILE"
    log "$LOGS_DIR" "$LOG_NAME" "Deterministic entropy file created at $ENTROPY_FILE"
fi

# Log assembly start
log "$LOGS_DIR" "$LOG_NAME" "Running SPAdes assembly for $INPUT_FILE"
log "$LOGS_DIR" "$LOG_NAME" "Sequencing type: $SEQUENCING_TYPE (using flag: $SPADES_FLAG)"
log "$LOGS_DIR" "$LOG_NAME" "Output directory: $SPADES_OUTPUT_DIR"
log "$LOGS_DIR" "$LOG_NAME" "Using $THREADS threads"

# Run SPAdes assembly
apptainer exec \
    --bind "$(dirname "$INPUT_FILE")":/mnt/input \
    --bind "$SPADES_OUTPUT_DIR":/mnt/output \
    --bind "$ENTROPY_FILE":/dev/random \
    --bind "$ENTROPY_FILE":/dev/urandom \
    "$straincascade_genome_assembly_sif" spades.py \
    -t "$THREADS" \
    --isolate \
    -o /mnt/output \
    "$SPADES_FLAG" "/mnt/input/$(basename "$INPUT_FILE")" || {
    log "$LOGS_DIR" "$LOG_NAME" "Error: SPAdes assembly failed for $INPUT_FILE. Skipping SPAdes assembly."
    exit 0
}

# Process assembly output
if [[ -f "$SPADES_OUTPUT_DIR/contigs.fasta" ]]; then
    # Check if file is empty
    if [[ ! -s "$SPADES_OUTPUT_DIR/contigs.fasta" ]]; then
        log "$LOGS_DIR" "$LOG_NAME" "Warning: Empty assembly file was generated by SPAdes. This is indicative of assembly failure and the assembly file will not be used downstream."
        exit 0
    fi
    mv "$SPADES_OUTPUT_DIR/contigs.fasta" "$SPADES_OUTPUT_DIR/$FINAL_ASSEMBLY_NAME"
    log "$LOGS_DIR" "$LOG_NAME" "Renamed contigs.fasta to $FINAL_ASSEMBLY_NAME"
    
    cp "$SPADES_OUTPUT_DIR/$FINAL_ASSEMBLY_NAME" "$GENOME_ASSEMBLY_DIR/"
    log "$LOGS_DIR" "$LOG_NAME" "Copied assembly to $GENOME_ASSEMBLY_DIR"
else
    log "$LOGS_DIR" "$LOG_NAME" "Error: Assembly file not found in $SPADES_OUTPUT_DIR. Skipping SPAdes assembly."
    exit 0
fi

# Perform genome size estimation if needed
if [[ ! -f "$GENOME_SIZE_FILE" ]]; then
    log "$LOGS_DIR" "$LOG_NAME" "Performing genome size estimation"
    
    # Select first assembly file for estimation
    readarray -t fasta_files < <(find "$GENOME_ASSEMBLY_DIR" -name "*.fasta")
    if [[ ${#fasta_files[@]} -eq 0 ]]; then
        log "$LOGS_DIR" "$LOG_NAME" "Error: No FASTA files found for genome size estimation. Skipping SPAdes assembly."
        exit 0
    fi
    selected_fasta="${fasta_files[0]}"
    
    # Calculate genome size with error handling
    if ! genome_size=$(grep -v ">" "$selected_fasta" | tr -d '\n' | tr -cd 'ACGTNacgtn' | wc -c); then
        log "$LOGS_DIR" "$LOG_NAME" "Error: Failed to calculate genome size from assembly. Skipping SPAdes assembly."
        exit 0
    fi
    log "$LOGS_DIR" "$LOG_NAME" "Estimated genome size: $genome_size bp"
    
    # Validate genome size
    if (( genome_size > MAX_PLAUSIBLE_GENOME_SIZE )); then
        log "$LOGS_DIR" "$LOG_NAME" "Warning: Genome size $genome_size bp is implausibly large for gut bacteria \
(https://doi.org/10.1038/s41467-023-37396-x, Fig. 1a). Skipping SPAdes assembly."
        exit 0
    elif (( genome_size <= MIN_VALID_GENOME_SIZE )); then
        log "$LOGS_DIR" "$LOG_NAME" "Warning: Genome size $genome_size bp may be too small for independent cell replication \
(https://www.science.org/doi/10.1126/science.1114057, Fig. 1). Skipping SPAdes assembly."
        exit 0
    else
        log "$LOGS_DIR" "$LOG_NAME" "Genome size $genome_size bp is within expected range"
        echo "$genome_size" > "$GENOME_SIZE_FILE"
    fi
fi

# Clean up empty FASTA files
log "$LOGS_DIR" "$LOG_NAME" "Checking for empty FASTA files in $GENOME_ASSEMBLY_DIR"
while IFS= read -r -d '' file; do
    if [[ -f "$file" && ! -s "$file" ]]; then
        log "$LOGS_DIR" "$LOG_NAME" "Removing empty file: $(basename "$file")"
        rm "$file"
    fi
done < <(find "$GENOME_ASSEMBLY_DIR" -type f -name "*.fasta" -print0)

log "$LOGS_DIR" "$LOG_NAME" "SPAdes assembly completed successfully"